#!/bin/sh

# Begin Functions
init_ports {
	local max_size="$1"
	
	echo "Initializng ports..."
	wait_for_seconds 5
	
	portsnap fetch
	portsnap extract	
	
	cd /usr/ports/devel/ccache
	make install clean
	
	echo "WRKDIRPREFIX=/ram" >> /etc/make.conf
	echo "CCACHE_DIR=/var/cache/ccache" >> /etc/make.conf
	echo "WITH_CCACHE_BUILD=yes" >> /etc/make.conf
	
	mkdir /ram
	echo 'none /ram tmpfs rw,size=2147483648 0 0' >> /etc/fstab
	mount /ram
	
	echo "max_size = ${max_size}" >> ~/.ccache/ccache.conf
	echo "cache_dir = /var/cache/ccache" >> ~/.ccache/ccache.conf
}
	
is_installed(){
	if ! [ -x "$(command -v $1)" ]; then
	  echo "Error: $1 is not installed." >&2
	  exit 1
	fi
}

check_requirements(){
	# Check if git is installed
	is_installed git
}

wait_for_seconds(){
	local seconds="$@"
	echo "waiting ${seconds} seconds before continuing..."
	sleep ${seconds}
}

read_property(){
	input="$@"
	temp=`cat $config_file | sed 's/\"//g' | grep -w $input | cut -d ":" -f2`
	echo ${temp##*|}
}

get_port_dir() {
	local port_name="$1"
	port_dir=$(whereis ${port_name})
	echo ${port_dir##*|}
} 

install_ports(){
	local ports_to_install="$@"
	# The list of ports must be comma separated with no empty space
	for port in $(echo $ports_to_install | sed "s/,/ /g")
	do
		local port_dir=get_port_dir $port
		cd ${port_dir} && make install clean
	done	
}
# End Functions

while [ "$1" != "" ]; do
    case $1 in
	-c | --config )		shift
                                config_file=$1
                                echo $config_file
                                ;;
        -h | --help )           usage
                                exit
                                ;;
        * )                     usage
                                exit 1
    esac
    shift
done

# Check if GIT is istalled
check_requiremnts 
 
# Variable Declaration
base_ports=$(read_property base_ports)
desktop_ports=$(read_property desktop_ports)
dev_ports=$(read_property dev_ports)
office_ports=$(read_property office_ports)

work_dir=.
config_file=${work_dir}/post_install.config

# Init Ports tree and Ramdisk for faster compilitaion
init_ports 5G
 
echo "Installing base packages..."
wait_for_seconds 5
install_ports $base_ports

echo "Installing desktop packages..."
wait_for_seconds 5
install_ports $desktop_ports

echo "Installing office packages..."
wait_for_seconds 5
install_ports $office_ports

echo "Installing development packages..."
wait_for_seconds 5
install_ports $dev_ports
 
exit 0
