#!/bin/sh

# Begin Functions
__read_property(){
	input="$@"
	temp=`cat $config_file | sed 's/\"//g' | grep -w $input | cut -d ":" -f2`
	echo ${temp##*|}
}

__wait_for_input(){
	printf 'press [ENTER] to continue...'
	read dummy
}

__wait_for_seconds(){
	local seconds="$@"
	echo "waiting ${seconds} seconds before continuing..."
	sleep ${seconds}
}
# End Functions

work_dir=.
config_file=${work_dir}/post_install.config

while [ "$1" != "" ]; do
    case $1 in
	    -c | --config )		    shift
                                config_file=$1
                                echo ${config_file}
                                ;;
        -h | --help )           usage
                                exit
                                ;;
        * )                     usage
                                exit 1
    esac
    shift
done

# Variable Declaration
port_system=$(__read_property port_system)

# Create Users
sh ./create_users

# Download Kernel
sh ./download_kernel

# Trigger pkg installation if run for the first time
pkg info

if [ ${port_system} == "PKG" ]
then
    __wait_for_seconds 5
	sh ./pkg_init
	if [ $? -eq 1 ]
    then
        exit 1
    fi
fi

if [ ${port_system} == "PORT" ]
then
	__wait_for_seconds 5
	sh ./port_init
	if [ $? -eq 1 ]
    then
        exit 1
    fi
fi

# Configure sudoers file /boot/loader.conf and /etc/rc.conf
sh ./configure_system

# Configure Groups and Users
sh ./configure_groups

echo "### Restart computer now... ###"
__wait_for_input
shutdown -r now

exit 0
